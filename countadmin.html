<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manikandapuram Temple Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fafafb; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        /* PRINT STYLES */
        @media print {
            .no-print { display: none !important; }
            #appScreen, #loginScreen, #successOverlay { display: none !important; }
            #printSection { display: block !important; background: white; position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0; z-index: 9999; }
            body { background: white; height: auto; overflow: visible; }
        }

        @media (max-width: 768px) {
            .mobile-bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #111827; color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-radius: 24px 24px 0 0; z-index: 50; }
            .mobile-cart-overlay { position: fixed; bottom: 0; left: 0; right: 0; height: 85vh; background: white; z-index: 60; border-radius: 32px 32px 0 0; padding: 24px; display: flex; flex-direction: column; }
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, query, where, or, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhzXyGNLYDDzQjA1w8NJ9NvyxAqv2onNY",
            authDomain: "temple-management-system-9c3c2.firebaseapp.com",
            projectId: "temple-management-system-9c3c2",
            storageBucket: "temple-management-system-9c3c2.firebasestorage.app",
            messagingSenderId: "960683500104",
            appId: "1:960683500104:web:e9b972349c28b98d7e2e7d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let cart = JSON.parse(localStorage.getItem('temple_cart')) || [];
        let autoMalayalamName = "";
        let isProcessing = false;

        onAuthStateChanged(auth, user => {
            document.getElementById('loginScreen').classList.toggle('hidden', !!user);
            document.getElementById('appScreen').classList.toggle('hidden', !user);
            
            if (user) { 
                document.getElementById('currentUser').innerText = user.email; 
                loadDeities(); 
                updateCart(); 
            } else {
                cart = [];
                localStorage.removeItem('temple_cart');
            }
        });

        window.login = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (e) { alert("Authorization failed."); }
        };

        window.handleLogout = async () => {
            if(confirm("Confirm Logout?")) {
                localStorage.removeItem('temple_cart'); 
                await signOut(auth); 
                window.location.reload(); 
            }
        };

        window.togglePassword = () => {
            const pwd = document.getElementById('password');
            pwd.type = pwd.type === "password" ? "text" : "password";
        };

        window.updateNameAndFetchML = async val => {
            document.getElementById('cartDevoteeName').innerText = val || "Devotee Name";
            if (!val) { autoMalayalamName = ""; return; }
            try {
                const r = await fetch(`https://inputtools.google.com/request?text=${val}&itc=ml-t-i0-und&num=1`);
                const d = await r.json();
                if (d[0] === "SUCCESS") autoMalayalamName = d[1][0][1][0];
            } catch {}
        };

        async function loadDeities() {
            const deityTabs = document.getElementById('deityTabs');
            deityTabs.innerHTML = "";
            const snap = await getDocs(collection(db, "deities"));
            let deities = [];
            snap.forEach(doc => deities.push(doc.data().name));

            const sortOrder = ["Ayyappan", "Ganapathi", "Muthappan", "Devi"];
            deities.sort((a, b) => {
                const idxA = sortOrder.indexOf(a);
                const idxB = sortOrder.indexOf(b);
                return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
            });

            deities.forEach(name => createTab(name, false));
            createTab("Special Vazhipadu", true); 
        }

        function createTab(name, isSpecial) {
            const b = document.createElement("button");
            const baseClass = "px-6 py-2 rounded-full border-2 font-bold transition-all text-xs uppercase shadow-sm whitespace-nowrap ";
            b.className = isSpecial 
                ? baseClass + "border-red-100 bg-red-50 text-red-900 hover:bg-red-600 hover:text-white"
                : baseClass + "border-orange-100 bg-white text-orange-900 hover:bg-orange-600 hover:text-white";
            b.innerText = name;
            b.onclick = () => filterPoojas(name, b, isSpecial);
            document.getElementById('deityTabs').appendChild(b);
        }

        async function filterPoojas(name, btn, isSpecial) {
            const deityTabs = document.getElementById('deityTabs');
            [...deityTabs.children].forEach(b => {
                const isSpec = b.innerText === "Special Vazhipadu";
                b.className = "px-6 py-2 rounded-full border-2 font-bold transition-all text-xs uppercase shadow-sm whitespace-nowrap " + 
                              (isSpec ? "border-red-100 bg-red-50 text-red-900" : "border-orange-100 bg-white text-orange-900");
            });

            btn.className = "px-6 py-2 rounded-full border-2 font-bold transition-all text-xs uppercase shadow-sm whitespace-nowrap text-white " + 
                            (isSpecial ? "bg-red-600 border-red-600" : "bg-orange-600 border-orange-600");

            const poojaCards = document.getElementById('poojaCards');
            poojaCards.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400">Loading...</div>';

            let q;
            if (isSpecial) {
                q = query(collection(db, "poojas")); 
            } else {
                q = query(collection(db, "poojas"), or(where("deity", "==", name), where("diety", "==", name)));
            }

            const snap = await getDocs(q);
            poojaCards.innerHTML = "";
            let list = [];
            snap.forEach(d => list.push(d.data()));

            if (isSpecial) {
                list = list.filter(p => p.price >= 500);
            } else {
                list = list.filter(p => p.price < 500);
            }

            if (list.length === 0) {
                poojaCards.innerHTML = '<div class="col-span-full text-center py-10 text-slate-300 font-bold">No items in this category</div>';
                return;
            }

            list.sort((a, b) => a.price - b.price);
            list.forEach(p => {
                const c = document.createElement('div');
                c.className = "bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:border-orange-500 cursor-pointer active:scale-95 transition-all";
                c.innerHTML = `<p class="font-bold text-slate-800 text-sm mb-1 line-clamp-1">${p.name_en}</p>
                               <p class="text-[10px] text-orange-600 font-bold uppercase mb-3">${p.name_ml}</p>
                               <div class="font-black text-xl text-slate-900">‚Çπ${p.price}</div>`;
                c.onclick = () => { cart.push(p); updateCart(); };
                poojaCards.appendChild(c);
            });
        }

        function updateCart() {
            const total = cart.reduce((s, i) => s + i.price, 0);
            document.getElementById('cartTotal').innerText = total;
            document.getElementById('mobileTotalDisplay').innerText = total;
            localStorage.setItem('temple_cart', JSON.stringify(cart));
            
            const html = cart.map((i, idx) => `
                <div class="flex justify-between items-start bg-white p-4 rounded-xl mb-3 border border-slate-100 shadow-sm">
                    <div class="flex flex-col">
                        <span class="text-sm font-black text-slate-800 leading-tight">${i.name_en}</span>
                        <span class="text-xs font-bold text-slate-500 mb-1">${i.name_ml}</span>
                        <span class="text-[10px] font-bold text-orange-600 uppercase tracking-wider bg-orange-50 px-2 py-1 rounded w-fit">${i.deity || i.diety || ''}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-900 text-lg">‚Çπ${i.price}</span>
                        <button onclick="removeFromCart(${idx})" class="text-slate-300 hover:text-red-500 font-bold text-xl px-2">√ó</button>
                    </div>
                </div>`).join("");
                
            document.getElementById('cartItems').innerHTML = html;
            document.getElementById('cartItemsMobile').innerHTML = html;
        }

        window.removeFromCart = i => { cart.splice(i, 1); updateCart(); };
        window.toggleMobileCart = () => document.getElementById('mobileCartOverlay').classList.toggle('hidden');

        window.finishPrint = () => {
            document.getElementById('printSection').classList.add('hidden'); 
            document.getElementById('appScreen').classList.remove('hidden'); 
            document.getElementById('successOverlay').classList.remove('hidden'); 
            document.body.classList.remove('overflow-hidden', 'h-screen');
        };

        window.startNewBill = () => {
            cart = []; localStorage.removeItem('temple_cart'); autoMalayalamName = ""; 
            document.getElementById('devoteeName').value = ""; 
            document.getElementById('cartDevoteeName').innerText = "Devotee Name"; 
            updateCart(); 
            document.getElementById('successOverlay').classList.add('hidden'); 
            if (!document.getElementById('mobileCartOverlay').classList.contains('hidden')) toggleMobileCart(); 
            isProcessing = false;
        };

        window.processBill = async e => {
            if (e) e.preventDefault();
            if (isProcessing) return;
            const dName = document.getElementById('devoteeName').value;
            if (!dName || cart.length === 0) return alert("Enter Name and select Poojas.");
            isProcessing = true;
            const items = JSON.parse(JSON.stringify(cart));
            const total = items.reduce((s, i) => s + i.price, 0);
            const mName = autoMalayalamName;
            const dStar = document.getElementById('devoteeStar').value;

            try {
                await addDoc(collection(db, "bookings"), { devoteeName: dName, devoteeNameMl: mName, star: dStar, items, total, timestamp: serverTimestamp() });

                // ‚úÖ UPDATED RECEIPT: Adds Deity in Brackets
                const receiptHtml = `
                    <div style="width: 58mm; margin: 0 auto; font-family: monospace; color: black; background: white; padding-top: 20px;">
                        <center><b style="font-size:14px;">MANIKANDAPURAM SREE<br>DHARMASASTHA TEMPLE</b><br><small>Paravoor, Panapuzha - 670306</small></center>
                        <div style="border-top:1px dashed #000; margin:10px 0;"></div>
                        <div style="font-size:12px;"><b>Name:</b> ${dName} / ${mName}<br><b>Star:</b> ${dStar}<br><b>Date:</b> ${new Date().toLocaleString('en-IN')}</div>
                        <div style="border-top:1px dashed #000; margin:10px 0;"></div>
                        ${items.map((i, index) => `
                            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:8px;">
                                <div style="display:flex; gap:5px;">
                                    <span>${index + 1}.</span>
                                    <div>
                                        <b>${i.name_en} <span style="font-weight:normal; font-size:9px;">(${i.deity || i.diety || ''})</span></b>
                                        <br>
                                        <span style="font-size:10px;">${i.name_ml}</span>
                                    </div>
                                </div>
                                <b>‚Çπ${i.price}</b>
                            </div>`).join("")}
                        <div style="border-top:1px dashed #000; margin:10px 0;"></div>
                        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:14px;"><span>TOTAL:</span><span>‚Çπ${total}</span></div>
                        <div style="border-top:1px dashed #000; margin:10px 0;"></div>
                        <center><br><b>Swami Saranam</b></center>
                    </div>
                    <div class="no-print" style="margin-top:40px; display:flex; gap:15px; justify-content:center; flex-direction: column; padding: 20px;">
                        <button onclick="window.print()" style="padding:15px; background:black; color:white; border-radius:12px; font-weight:bold; border:none; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">üñ®Ô∏è CLICK TO PRINT / SAVE PDF</button>
                        <button onclick="finishPrint()" style="padding:15px; background:#ef4444; color:white; border-radius:12px; font-weight:bold; border:none; font-size: 14px; box-shadow: 0 4px 15px rgba(239,68,68,0.3);">‚ùå CLOSE & NEXT</button>
                    </div>`;

                const printSection = document.getElementById('printSection');
                printSection.innerHTML = receiptHtml;
                document.getElementById('appScreen').classList.add('hidden'); 
                printSection.classList.remove('hidden'); 
                document.body.classList.remove('overflow-hidden', 'h-screen');

            } catch (err) { alert("Error: " + err.message); isProcessing = false; }
        };
    </script>
</head>
<body class="h-screen overflow-hidden flex flex-col bg-[#fafafb]">
    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-[#fafafb] p-6">
        <div class="w-full max-w-[450px]">
            <div class="text-center mb-10"><div class="inline-flex items-center justify-center w-16 h-16 bg-orange-600 rounded-2xl shadow-xl shadow-orange-200 mb-6"><span class="text-white font-black text-xl">MSDT</span></div>
            <h1 class="text-2xl font-black text-slate-800 tracking-tight uppercase">Manikandapuram Temple</h1><p class="text-slate-400 font-bold text-xs uppercase tracking-[0.2em] mt-2">Admin Portal Login</p></div>
            <div class="bg-white p-8 md:p-12 rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.04)] border border-slate-100"><div class="space-y-6">
                <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Administrator Email</label><input type="email" id="email" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl outline-none focus:border-orange-500 font-semibold text-slate-700" placeholder="admin@temple.com"></div>
                <div><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Security Password</label><div class="relative"><input type="password" id="password" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl outline-none focus:border-orange-500 font-semibold text-slate-700" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><button type="button" onclick="togglePassword()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.644m19.928.644a1.012 1.012 0 000-.644M12 18.75c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8ZM12 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5Z" /></svg></button></div></div>
                <div class="pt-2"><button onclick="login()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-2xl hover:bg-orange-600 active:scale-[0.98] transition-all uppercase tracking-widest text-[11px]">Authorize & Sign In</button></div>
            </div></div>
        </div>
    </div>

    <div id="appScreen" class="hidden h-screen flex flex-col overflow-hidden">
        <header class="bg-white border-b border-slate-100 py-4 flex justify-between items-center px-6 md:px-10 shrink-0">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-orange-600 rounded-xl flex items-center justify-center text-white font-bold text-xs shadow-lg">MSDT</div><h1 class="font-black text-slate-900 uppercase text-[10px] md:text-lg tracking-tight">Temple Management Portal</h1></div>
            <div class="flex items-center gap-4"><span id="currentUser" class="hidden md:inline text-slate-400 font-bold text-xs"></span><button onclick="handleLogout()" class="bg-red-50 text-red-600 font-bold text-[10px] px-4 py-2 rounded-full border border-red-100 uppercase tracking-widest">Logout</button></div>
        </header>
        <main class="flex flex-1 overflow-hidden relative">
            <div class="flex-1 p-4 md:p-10 overflow-y-auto space-y-6 bg-[#fafafb] custom-scroll pb-24 md:pb-10">
                <div class="bg-white p-5 md:p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4 md:gap-8">
                    <div class="flex-[2] space-y-2"><label class="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Devotee Name</label><input id="devoteeName" oninput="updateNameAndFetchML(this.value)" class="w-full bg-slate-50 border border-transparent p-4 rounded-2xl outline-none focus:bg-white focus:border-orange-500 font-bold text-slate-700" placeholder="Enter Name"></div>
                    <div class="flex-1 space-y-2"><label class="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Nakshatram</label><select id="devoteeStar" class="w-full bg-slate-50 border border-transparent p-4 rounded-2xl outline-none focus:bg-white focus:border-orange-500 font-bold text-slate-700"><option>Ashwati / ‡¥Ö‡¥∂‡µç‡¥µ‡¥§‡¥ø</option><option>Bharani / ‡¥≠‡¥∞‡¥£‡¥ø</option><option>Kartika / ‡¥ï‡¥æ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ï</option><option>Rohini / ‡¥∞‡µã‡¥π‡¥ø‡¥£‡¥ø</option><option>Makayiram / ‡¥Æ‡¥ï‡¥Ø‡¥ø‡¥∞‡¥Ç</option><option>Thiruvathira / ‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡¥æ‡¥§‡¥ø‡¥∞</option><option>Punartham / ‡¥™‡µÅ‡¥£‡µº‡¥§‡¥Ç</option><option>Pooyam / ‡¥™‡µÇ‡¥Ø‡¥Ç</option><option>Ayilyam / ‡¥Ü‡¥Ø‡¥ø‡¥≤‡µç‡¥Ø‡¥Ç</option><option>Makam / ‡¥Æ‡¥ï‡¥Ç</option><option>Pooram / ‡¥™‡µÇ‡¥∞‡¥Ç</option><option>Uthram / ‡¥â‡¥§‡µç‡¥∞‡¥Ç</option><option>Atham / ‡¥Ö‡¥§‡µç‡¥§‡¥Ç</option><option>Chitra / ‡¥ö‡¥ø‡¥§‡µç‡¥∞</option><option>Chothi / ‡¥ö‡µã‡¥§‡¥ø</option><option>Vishakham / ‡¥µ‡¥ø‡¥∂‡¥æ‡¥ñ‡¥Ç</option><option>Anizham / ‡¥Ö‡¥®‡¥ø‡¥¥‡¥Ç</option><option>Thrikketta / ‡¥§‡µÉ‡¥ï‡µç‡¥ï‡µá‡¥ü‡µç‡¥ü</option><option>Moolam / ‡¥Æ‡µÇ‡¥≤‡¥Ç</option><option>Pooradam / ‡¥™‡µÇ‡¥∞‡¥æ‡¥ü‡¥Ç</option><option>Uthradam / ‡¥â‡¥§‡µç‡¥∞‡¥æ‡¥ü‡¥Ç</option><option>Thiruvonam / ‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡µã‡¥£‡¥Ç</option><option>Avittam / ‡¥Ö‡¥µ‡¥ø‡¥ü‡µç‡¥ü‡¥Ç</option><option>Chathayam / ‡¥ö‡¥§‡¥Ø‡¥Ç</option><option>Pooruruttathi / ‡¥™‡µÇ‡¥∞‡µÅ‡¥∞‡µÅ‡¥ü‡µç‡¥ü‡¥æ‡¥§‡¥ø</option><option>Uthruttathi / ‡¥â‡¥§‡µç‡¥∞‡¥ü‡µç‡¥ü‡¥æ‡¥§‡¥ø</option><option>Revathi / ‡¥∞‡µá‡¥µ‡¥§‡¥ø</option></select></div>
                </div>
                <div id="deityTabs" class="flex gap-3 overflow-x-auto pb-2 custom-scroll"></div>
                <div id="poojaCards" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            </div>
            <div class="hidden md:flex w-96 p-8 bg-white border-l border-slate-100 flex-col shadow-sm shrink-0">
                <div class="mb-8"><h3 class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">Current Bill</h3><div id="cartDevoteeName" class="font-black text-slate-800 text-2xl truncate">Devotee Name</div></div>
                <div id="cartItems" class="flex-1 overflow-y-auto custom-scroll pr-2"></div>
                <div class="pt-8 border-t border-slate-100 mt-6"><div class="flex justify-between items-end mb-6"><span class="text-4xl font-black text-orange-600 leading-none">‚Çπ<span id="cartTotal">0</span></span></div><button onclick="processBill(event)" class="w-full bg-slate-900 text-white font-black py-5 rounded-[1.5rem] shadow-xl hover:bg-black transition-all uppercase tracking-widest text-[10px]">Save & Print Bill</button></div>
            </div>
            <div class="mobile-bottom-bar md:hidden" onclick="toggleMobileCart()"><span class="text-xl font-black text-orange-400">‚Çπ<span id="mobileTotalDisplay">0</span></span><button onclick="processBill(event);event.stopPropagation()" class="bg-orange-600 text-white px-8 py-3 rounded-xl font-black text-xs uppercase shadow-lg shadow-orange-900/30">Save</button></div>
            <div id="mobileCartOverlay" class="mobile-cart-overlay hidden md:hidden"><div class="flex justify-between items-center mb-8"><h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">Vazhipadu Bill</h3><button onclick="toggleMobileCart()">‚úï</button></div><div id="cartItemsMobile" class="flex-1 overflow-y-auto custom-scroll pr-2"></div><button onclick="processBill(event)" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl mt-6 shadow-xl uppercase tracking-widest">Confirm & Print</button></div>
            <div id="successOverlay" class="fixed inset-0 bg-slate-900/90 z-[200] hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm p-8 rounded-[2rem] text-center shadow-2xl"><div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-sm">‚úì</div><h2 class="text-2xl font-black text-slate-800 mb-2">Vazhipadu Saved!</h2><button onclick="startNewBill()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl">Start Next Devotee</button></div></div>
        </main>
    </div>
    <div id="printSection" class="hidden h-screen w-full bg-white flex-col items-center pt-10"></div>
</body>
</html>
