<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manikandapuram Sree Dharmasastha Temple Billing & Management Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, or } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhzXyGNLYDDzQjA1w8NJ9NvyxAqv2onNY",
            authDomain: "temple-management-system-9c3c2.firebaseapp.com",
            projectId: "temple-management-system-9c3c2",
            storageBucket: "temple-management-system-9c3c2.firebasestorage.app",
            messagingSenderId: "960683500104",
            appId: "1:960683500104:web:e9b972349c28b98d7e2e7d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let cart = [];
        let autoMalayalamName = "";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('currentUser').innerText = user.email;
                loadDeities();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        });

        window.updateNameAndFetchML = async (val) => {
            document.getElementById('cartDevoteeName').innerText = val || "Devotee Name";
            if (!val) { autoMalayalamName = ""; return; }
            try {
                const response = await fetch(`https://inputtools.google.com/request?text=${val}&itc=ml-t-i0-und&num=1`);
                const data = await response.json();
                if (data[0] === "SUCCESS") autoMalayalamName = data[1][0][1][0];
            } catch (e) { console.error("Transliteration Error"); }
        };

        window.login = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
            catch (e) { alert("Login failed."); }
        };

        window.togglePassword = () => {
            const pwd = document.getElementById('password');
            pwd.type = pwd.type === "password" ? "text" : "password";
        };

        window.handleLogout = () => { if(confirm("Logout from Portal?")) signOut(auth); };

        async function loadDeities() {
            const snap = await getDocs(collection(db, "deities"));
            const container = document.getElementById('deityTabs');
            container.innerHTML = '';
            snap.forEach(doc => {
                const btn = document.createElement('button');
                btn.className = "px-5 py-2 rounded-full border border-orange-200 bg-white text-orange-900 font-bold hover:bg-orange-600 hover:text-white transition-all text-xs uppercase shadow-sm whitespace-nowrap";
                btn.innerText = doc.data().name;
                btn.onclick = () => filterPoojas(doc.data().name, btn);
                container.appendChild(btn);
            });
        }

        async function filterPoojas(deityName, btn) {
            document.querySelectorAll('#deityTabs button').forEach(b => {
                b.classList.remove('bg-orange-600', 'text-white');
                b.classList.add('bg-white', 'text-orange-900');
            });
            btn.classList.add('bg-orange-600', 'text-white');

            const q = query(collection(db, "poojas"), or(where("diety", "==", deityName), where("deity", "==", deityName)));
            const snap = await getDocs(q);
            const container = document.getElementById('poojaCards');
            container.innerHTML = '';

            let poojas = [];
            snap.forEach(doc => poojas.push(doc.data()));
            poojas.sort((a, b) => a.price - b.price);

            poojas.forEach(p => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:border-orange-500 cursor-pointer active:scale-95 transition-all";
                card.innerHTML = `<p class="font-bold text-slate-800 text-sm mb-1 line-clamp-1">${p.name_en}</p><p class="text-orange-600 text-[10px] mb-2 uppercase">${p.name_ml}</p><div class="text-lg font-black text-slate-900">‚Çπ${p.price}</div>`;
                card.onclick = () => { cart.push(p); updateCartUI(); };
                container.appendChild(card);
            });
        }

        function updateCartUI() {
            const container = document.getElementById('cartItems');
            const mobileContainer = document.getElementById('cartItemsMobile');
            const total = cart.reduce((s,i) => s + i.price, 0);
            
            document.getElementById('cartTotal').innerText = total;
            document.getElementById('mobileTotalDisplay').innerText = total;

            const html = cart.map((item, index) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg mb-2 border border-slate-100">
                    <div class="flex flex-col"><span class="font-bold text-slate-700 text-xs">${item.name_en}</span></div>
                    <div class="flex items-center gap-3"><span class="font-bold text-sm">‚Çπ${item.price}</span>
                    <button onclick="removeFromCart(${index})" class="text-red-500 font-bold px-2">‚úï</button></div>
                </div>`).join('');
            
            container.innerHTML = html;
            if (mobileContainer) mobileContainer.innerHTML = html;
        }

        window.removeFromCart = (i) => { cart.splice(i, 1); updateCartUI(); event.stopPropagation(); };

        window.toggleMobileCart = () => {
            const overlay = document.getElementById('mobileCartOverlay');
            overlay.classList.toggle('hidden');
        };

        window.processBill = async () => {
            const nameEn = document.getElementById('devoteeName').value;
            const star = document.getElementById('devoteeStar').value;
            
            if(!nameEn || cart.length === 0) return alert("Enter Name & Poojas");

            // Fix: Calculate final total directly from current cart array
            const finalTotal = cart.reduce((s,i) => s + i.price, 0);

            // Populate Receipt
            document.getElementById('printNameCombo').innerText = `${nameEn} / ${autoMalayalamName}`;
            document.getElementById('printStar').innerText = star;
            document.getElementById('printDate').innerText = new Date().toLocaleString('en-IN');
            document.getElementById('printTotal').innerText = finalTotal;
            document.getElementById('printItems').innerHTML = cart.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:4px; font-size:11px;"><div><b>${i.name_en}</b><br>${i.name_ml}</div><div style="font-weight:bold;">‚Çπ${i.price}</div></div>`).join('');

            try {
                // Save to Firebase
                await addDoc(collection(db, "bookings"), { 
                    devoteeName: nameEn, 
                    devoteeNameMl: autoMalayalamName, 
                    star: star, 
                    items: cart, 
                    total: finalTotal, 
                    timestamp: serverTimestamp() 
                });
                
                window.print();
                
                // Clear state
                cart = [];
                document.getElementById('devoteeName').value = "";
                updateCartUI();
                if (!document.getElementById('mobileCartOverlay').classList.contains('hidden')) toggleMobileCart();
            } catch (e) {
                alert("Database Error: " + e.message);
            }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fafafb; }
        @media print { .no-print { display: none !important; } #thermal-receipt { display: block !important; width: 58mm; margin: 0 auto; } }
        #thermal-receipt { display: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        @media (max-width: 768px) {
            .mobile-bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #111827; color: white; padding: 12px 20px; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.2); }
            .mobile-cart-overlay { position: fixed; bottom: 0; left: 0; right: 0; height: 80vh; background: white; z-index: 110; box-shadow: 0 -10px 30px rgba(0,0,0,0.3); border-radius: 30px 30px 0 0; padding: 25px; display: flex; flex-direction: column; transition: all 0.3s ease; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-orange-50 p-6">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm border border-orange-100 text-center">
            <h2 class="text-xl font-black text-slate-800 uppercase tracking-tight mb-8">Portal Login</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full bg-slate-50 border p-4 rounded-2xl outline-none focus:border-orange-500 font-semibold">
                <div class="relative"><input type="password" id="password" placeholder="Password" class="w-full bg-slate-50 border p-4 rounded-2xl outline-none focus:border-orange-500 font-semibold">
                <button type="button" onclick="togglePassword()" class="absolute right-4 top-4 text-slate-400">üëÅÔ∏è</button></div>
                <button onclick="login()" class="w-full bg-orange-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-orange-700 transition-all uppercase tracking-widest text-xs">SIGN IN</button>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden flex flex-col h-screen no-print overflow-hidden">
        <header class="bg-white border-b border-slate-100 py-4 flex justify-between items-center px-6 md:px-10 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-orange-600 rounded-xl flex items-center justify-center text-white font-bold text-xs shadow-lg">MSDT</div>
                <h1 class="font-black text-slate-900 uppercase text-[10px] md:text-lg tracking-tight">Manikandapuram Temple Portal</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="currentUser" class="hidden md:inline text-slate-400 font-bold text-xs"></span>
                <button onclick="handleLogout()" class="bg-red-50 text-red-500 font-bold text-[10px] px-4 py-2 rounded-full border border-red-100">LOGOUT</button>
            </div>
        </header>

        <main class="flex flex-1 overflow-hidden relative">
            <div class="flex-1 p-4 md:p-10 overflow-y-auto space-y-6 md:space-y-8 bg-[#fafafb] custom-scroll pb-24 md:pb-10">
                <div class="bg-white p-5 md:p-8 rounded-2xl md:rounded-[2rem] shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4">
                    <div class="flex-1 space-y-2"><label class="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Devotee Name</label>
                    <input type="text" id="devoteeName" oninput="updateNameAndFetchML(this.value)" placeholder="English Name" class="w-full bg-slate-50 border border-transparent p-3 rounded-xl focus:bg-white focus:border-orange-500 outline-none font-bold text-slate-700"></div>
                    <div class="flex-1 space-y-2"><label class="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Nakshatram</label>
                    <select id="devoteeStar" class="w-full bg-slate-50 border border-transparent p-3 rounded-xl outline-none focus:bg-white focus:border-orange-500 font-bold text-slate-700">
                        <option>Ashwati / ‡¥Ö‡¥∂‡µç‡¥µ‡¥§‡¥ø</option><option>Bharani / ‡¥≠‡¥∞‡¥£‡¥ø</option><option>Kartika / ‡¥ï‡¥æ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ï</option><option>Rohini / ‡¥∞‡µã‡¥π‡¥ø‡¥£‡¥ø</option><option>Makayiram / ‡¥Æ‡¥ï‡¥Ø‡¥ø‡¥∞‡¥Ç</option><option>Thiruvathira / ‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡¥æ‡¥§‡¥ø‡¥∞</option><option>Punartham / ‡¥™‡µÅ‡¥£‡µº‡¥§‡¥Ç</option><option>Pooyam / ‡¥™‡µÇ‡¥Ø‡¥Ç</option><option>Ayilyam / ‡¥Ü‡¥Ø‡¥ø‡¥≤‡µç‡¥Ø‡¥Ç</option><option>Makam / ‡¥Æ‡¥ï‡¥Ç</option><option>Pooram / ‡¥™‡µÇ‡¥∞‡¥Ç</option><option>Uthram / ‡¥â‡¥§‡µç‡¥∞‡¥Ç</option><option>Atham / ‡¥Ö‡¥§‡µç‡¥§‡¥Ç</option><option>Chitra / ‡¥ö‡¥ø‡¥§‡µç‡¥∞</option><option>Chothi / ‡¥ö‡µã‡¥§‡¥ø</option><option>Vishakham / ‡¥µ‡¥ø‡¥∂‡¥æ‡¥ñ‡¥Ç</option><option>Anizham / ‡¥Ö‡¥®‡¥ø‡¥¥‡¥Ç</option><option>Thrikketta / ‡¥§‡µÉ‡¥ï‡µç‡¥ï‡µá‡¥ü‡µç‡¥ü</option><option>Moolam / ‡¥Æ‡µÇ‡¥≤‡¥Ç</option><option>Pooradam / ‡¥™‡µÇ‡¥∞‡¥æ‡¥ü‡¥Ç</option><option>Uthradam / ‡¥â‡¥§‡µç‡¥∞‡¥æ‡¥ü‡¥Ç</option><option>Thiruvonam / ‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡µã‡¥£‡¥Ç</option><option>Avittam / ‡¥Ö‡¥µ‡¥ø‡¥ü‡µç‡¥ü‡¥Ç</option><option>Chathayam / ‡¥ö‡¥§‡¥Ø‡¥Ç</option><option>Pooruruttathi / ‡¥™‡µÇ‡¥∞‡µÅ‡¥∞‡µÅ‡¥ü‡µç‡¥ü‡¥æ‡¥§‡¥ø</option><option>Uthruttathi / ‡¥â‡¥§‡µç‡¥∞‡¥ü‡µç‡¥ü‡¥æ‡¥§‡¥ø</option><option>Revathi / ‡¥∞‡µá‡¥µ‡¥§‡¥ø</option>
                    </select></div>
                </div>
                <div id="deityTabs" class="flex overflow-x-auto gap-2 pb-2 scrollbar-hide"></div>
                <div id="poojaCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-4"></div>
            </div>

            <div id="checkoutSidebar" class="hidden md:flex w-96 bg-white border-l border-slate-100 flex-col p-8 shadow-sm">
                <div class="mb-8 font-black text-slate-800 text-2xl truncate" id="cartDevoteeName">Devotee Name</div>
                <div class="flex-1 overflow-y-auto" id="cartItems"></div>
                <div class="pt-8 border-t border-slate-100 mt-6 flex justify-between items-end mb-6">
                    <span class="text-slate-300 text-[9px] font-black uppercase tracking-widest">Grand Total</span>
                    <span class="text-4xl font-black text-orange-600">‚Çπ<span id="cartTotal">0</span></span>
                </div>
                <button onclick="processBill()" class="w-full bg-slate-900 text-white font-black py-5 rounded-[1.5rem] shadow-xl hover:bg-black uppercase tracking-widest text-[10px]">Save & Print</button>
            </div>

            <div class="md:hidden mobile-bottom-bar no-print" onclick="toggleMobileCart()">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">View Bill</span>
                    <span class="text-xl font-black text-orange-400">‚Çπ<span id="mobileTotalDisplay">0</span></span>
                </div>
                <button onclick="processBill(); event.stopPropagation();" class="bg-orange-600 text-white font-black px-6 py-3 rounded-xl text-xs uppercase shadow-lg">SAVE & PRINT</button>
            </div>

            <div id="mobileCartOverlay" class="md:hidden hidden mobile-cart-overlay no-print">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-slate-800 uppercase text-lg">Current Bill</h3>
                    <button onclick="toggleMobileCart()" class="bg-slate-100 p-2 rounded-full text-slate-400 font-bold">‚úï</button>
                </div>
                <div class="flex-1 overflow-y-auto" id="cartItemsMobile"></div>
                <button onclick="processBill()" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl mt-4 shadow-xl uppercase tracking-widest">Confirm & Print</button>
            </div>
        </main>
    </div>

    <div id="thermal-receipt" style="width: 58mm; padding: 10px; font-family: 'Courier New', monospace;">
        <div style="text-align: center; margin-bottom: 5px;">
            <strong style="font-size: 13px; text-transform: uppercase;">Manikandapuram Sree Dharmasastha Temple</strong><br>
            <span style="font-size: 9px;">Paravoor, Panapuzha - 670306</span><br>
            <div style="border-top:1px dashed #000; border-bottom:1px dashed #000; margin: 5px 0; padding: 4px 0; font-weight: bold; font-size: 11px;">VAZHIPADU RECEIPT</div>
        </div>
        <div style="font-size: 10px; margin-bottom: 5px; line-height: 1.4;">
            <b>Name: <span id="printNameCombo"></span></b><br>
            Star: <span id="printStar"></span><br>
            Date: <span id="printDate"></span>
        </div>
        <div style="border-top: 1px dashed #000; margin-bottom: 5px;"></div>
        <div id="printItems" style="border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 5px;"></div>
        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px;"><span>TOTAL:</span><span>‚Çπ<span id="printTotal"></span></span></div>
        <div style="text-align: center; margin-top: 15px; font-size: 11px; font-weight: bold;">Swami Saranam</div>
    </div>
</body>
</html>
